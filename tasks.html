<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>任务中心 - 鸟国网站</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <h1 class="site-title"><a href="index.html" style="text-decoration:none;color:inherit;">鸟国网站</a></h1>
        <nav class="site-nav">
          <a href="index.html">首页</a>
          <a href="features.html">功能分类</a>
          <a href="downloads.html">软件下载</a>
          <a href="tutorials.html">教程专区</a>
          <a href="vm.html">虚拟机专区</a>
          <a href="os.html">系统镜像专区</a>
          <a href="games.html">游戏专区</a>
          <a href="official.html">官方跳转</a>
          <a href="tasks.html" class="active" id="navTasks">任务</a>
          <a href="user.html" id="navUser">用户</a>
          <a href="#" id="navLogin">登录</a>
        </nav>
      </div>
    </header>
    <main>
      <section class="section">
        <div class="container" style="max-width:760px;">
          <h3>每日任务</h3>
          <div class="card">
    <p>说明：在站内任意页面停留累计满 15 分钟，可获得 <strong>5 积分</strong>（每天限一次）。</p>
            <p>当前用户：<span id="taskUser">未登录</span> ｜ 当前积分：<span id="taskPoints">0</span></p>
            <div style="margin-top:6px;">
              <div class="progress"><div class="progress-bar" id="taskBar"></div></div>
    <p id="taskText" style="margin:8px 0 0;color:var(--muted);">今日进度：0 / 15 分钟</p>
            </div>
            <p style="margin-top:8px;color:var(--muted);font-size:13px;">提示：保持任意站内页面打开即可计时；完成后自动发放积分。</p>
          </div>

          <div class="card">
            <h4>未来任务（规划）</h4>
            <ul>
              <li>完善资料并绑定邮箱：+10 积分</li>
              <li>完成新手引导：+8 积分</li>
              <li>每日答题：+5 积分</li>
            </ul>
            <p style="color:var(--muted);font-size:13px;">以上为预告项，后续接入后端后开放。</p>
          </div>
        </div>
      </section>
      
      <!-- 可选任务：语言答题与资料绑定 -->
      <section class="section">
        <div class="container" style="max-width:860px;">
          <h3>可选任务</h3>

          <div class="card">
            <h4><img src="favicon.svg" alt="bird" style="height:22px;vertical-align:middle;margin-right:6px;" />编程语言闯关（Python / C++ / C / Go / Java）</h4>
            <p>自选语言与难度（简单 c1~c3 / 困难 c4~c6 / 地狱 c7~c8）。随机生成 10 道选择题、20 道判断题、1 道编程题。提交后按正确题目累计积分：</p>
            <ul>
              <li>简单：选择每题 1 分，判断每题 1 分，编程题额外 +10 分</li>
              <li>困难：选择每题 2 分，判断每题 3 分，编程题额外 +20 分</li>
              <li>地狱：选择每题 5 分，判断每题 6 分，编程题额外 +50 分</li>
            </ul>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0;">
              <label>语言：
                <select id="quizLangSel">
                  <option value="python">Python</option>
                  <option value="cpp">C++</option>
                  <option value="c">C</option>
                  <option value="go">Go</option>
                  <option value="java">Java</option>
                </select>
              </label>
              <label>难度：
                <select id="quizLevelSel">
                  <option value="easy">简单（c1~c3）</option>
                  <option value="hard">困难（c4~c6）</option>
                  <option value="hell">地狱（c7~c8）</option>
                </select>
              </label>
              <label>题量：
                <select id="quizCountSel">
                  <option value="10">10 题</option>
                  <option value="20">20 题</option>
                </select>
              </label>
              <button class="btn" id="genQuizBtn">生成试卷</button>
            </div>
            <div id="quizArea">
              <p style="color:var(--muted)">未生成试卷。</p>
            </div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn primary" id="submitQuizBtn" disabled>提交并计分</button>
              <button class="btn" id="collapseQuizBtn" disabled>收起试卷</button>
              <span id="quizScoreText" style="align-self:center;color:var(--muted)"></span>
            </div>
          </div>

          <div class="card">
            <h4>新手教程跳过补回</h4>
            <p>如果你已跳过新手教程，可在此补回 <strong>+8 积分</strong>（每个账号仅一次）。</p>
            <button class="btn" id="newbieBonusBtn">补回新手积分 +8</button>
            <span id="newbieStatus" style="margin-left:10px;color:var(--muted)"></span>
          </div>

          <div class="card">
            <h4>绑定邮箱 / 手机号</h4>
            <p>完善资料可获得 <strong>+10 积分</strong>（每个账号仅一次）。任填邮箱或手机号之一即可。</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
              <input id="bindEmail" type="email" placeholder="邮箱（可选）" style="min-width:220px;flex:1;" />
              <input id="bindPhone" type="tel" placeholder="手机号（可选）" style="min-width:180px;" />
              <button class="btn" id="bindBtn">绑定并领取 +10</button>
            </div>
            <span id="bindStatus" style="display:block;margin-top:8px;color:var(--muted)"></span>
          </div>
        </div>
      </section>
    </main>
    <footer class="site-footer"><div class="container"><span>© 2025 鸟国网站 niaoguo.com</span></div></footer>

    <!-- 静态模式：禁用后端 API，任务积分仅为本地演示 -->
    <script>
      (function(){
        window.Niao = window.Niao || {};
        window.Niao.config = window.Niao.config || {};
        window.Niao.config.static = false;
        window.Niao.config.apiBase = 'http://localhost:5050';
      })();
    </script>
    <script src="script.js"></script>
    <script>
      (async function(){
        const u = window.Niao?.auth?.getSessionUser() || '';
        const taskUser = document.getElementById('taskUser');
        const taskPoints = document.getElementById('taskPoints');
        const taskBar = document.getElementById('taskBar');
        const taskText = document.getElementById('taskText');
        taskUser.textContent = u || '未登录';
        if (u) {
          try {
            const pts = await window.Niao?.auth?.getPoints(u);
            taskPoints.textContent = String(pts || 0);
          } catch(_) {
            taskPoints.textContent = '0';
          }
        } else {
          taskPoints.textContent = '0';
        }
        window.Niao?.daily?.bindUI({ barEl: taskBar, textEl: taskText, pointsEl: taskPoints });

        // ====== 资料绑定与新手补回 ======
        const bindBtn = document.getElementById('bindBtn');
        const bindEmail = document.getElementById('bindEmail');
        const bindPhone = document.getElementById('bindPhone');
        const bindStatus = document.getElementById('bindStatus');
        const newbieBtn = document.getElementById('newbieBonusBtn');
        const newbieStatus = document.getElementById('newbieStatus');
        function readRaw(k, d){ const v = localStorage.getItem(k); return v==null?d:v; }
        function writeRaw(k, v){ try{ localStorage.setItem(k, String(v)); }catch(_){} }
        function validEmail(s){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(s||'').trim()); }
        function validPhone(s){ const t = String(s||'').trim(); return /^1[3-9]\d{9}$/.test(t) || /^\+?\d{7,15}$/.test(t); }
        function refreshBindState(){
          if (!u) { bindStatus.textContent = '请先登录再绑定与领取积分。'; return; }
          const prof = JSON.parse(readRaw('niao.profile.'+u, '{}')||'{}');
          const done = readRaw('niao.bonus.bind.'+u, '')==='1';
          bindEmail.value = prof.email||''; bindPhone.value = prof.phone||'';
          bindStatus.textContent = done? '已领取绑定奖励 +10' : '未领取绑定奖励';
        }
        function refreshNewbieState(){
          if (!u) { newbieStatus.textContent = '请先登录再领取。'; return; }
          const done = readRaw('niao.bonus.newbie.'+u, '')==='1';
          newbieStatus.textContent = done? '已补回 +8 积分' : '未领取';
        }
        if (bindBtn) bindBtn.addEventListener('click', async () => {
          if (!u) { alert('请先登录'); return; }
          const em = bindEmail.value; const ph = bindPhone.value;
          if (!validEmail(em) && !validPhone(ph)) { alert('请至少填写有效的邮箱或手机号'); return; }
          const profKey = 'niao.profile.'+u; const prof = JSON.parse(readRaw(profKey, '{}')||'{}');
          prof.email = em||prof.email||''; prof.phone = ph||prof.phone||''; writeRaw(profKey, JSON.stringify(prof));
          if (readRaw('niao.bonus.bind.'+u, '')!=='1') {
            await window.Niao?.auth?.addPoints(u, 10, 'bind'); writeRaw('niao.bonus.bind.'+u, '1');
          }
          refreshBindState(); const pts = await window.Niao?.auth?.getPoints(u); taskPoints.textContent = String(pts||0);
          alert('已保存资料并领取绑定奖励');
        });
        if (newbieBtn) newbieBtn.addEventListener('click', async () => {
          if (!u) { alert('请先登录'); return; }
          if (readRaw('niao.bonus.newbie.'+u, '')==='1') { alert('此奖励每个账号仅限一次'); return; }
          await window.Niao?.auth?.addPoints(u, 8, 'newbie'); writeRaw('niao.bonus.newbie.'+u, '1');
          refreshNewbieState(); const pts = await window.Niao?.auth?.getPoints(u); taskPoints.textContent = String(pts||0);
          alert('已补回新手积分 +8');
        });
        refreshBindState(); refreshNewbieState();

        // ====== 语言答题：题库与出题 ======
        const QUIZ_CFG = {
          easy: { choice:1, tf:1, code:10 },
          hard: { choice:2, tf:3, code:20 },
          hell: { choice:5, tf:6, code:50 }
        };
        function mc(q, correct, distractors){ const opts = [correct, ...distractors].slice(0,4); // 保留前4个
          // 打乱
          for(let i=opts.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[opts[i],opts[j]]=[opts[j],opts[i]]}
          const idx = opts.indexOf(correct); return { q, options:opts, answerIndex: idx<0?0:idx }; }
        const BANK = {
          python: {
            easy: {
              mc: [
                mc('Python 输出一行文本的函数是？', 'print()', ['printf()', 'System.out.println()', 'fmt.Println()']),
                mc('Python 单行注释使用哪个符号？', '#', ['//','<!-- -->','/* */']),
                mc('Python 导入标准库 math 的语句是？', 'import math', ['#include <math.h>', 'import java.util.*', 'import "math"']),
                mc('Python 变量声明正确的是？', 'x = 1', ['int x = 1;', 'var x int = 1', 'auto x = 1;']),
                mc('Python 判断入口常见写法是？', 'if __name__ == "__main__":', ['public static void main', 'int main()', 'func main()']),
                mc('Python 列表是？', '可变序列(list)', ['不可变序列(tuple)', '映射(dict)', '集合(set)'])
              ],
              tf: [
                {q:'Python 列表是 0 开始索引', a:true},
                {q:'Python 使用缩进表示代码块', a:true},
                {q:'Python 必须在每行结尾写分号', a:false},
                {q:'tuple 是可变类型', a:false},
                {q:'dict 支持键值对存储', a:true},
                {q:'range(5) 产生 0..5（含5）', a:false}
              ],
              code: [
                {q:'读取整数 n，打印 1..n 的和', hint:'使用 for 循环或 sum(range(...))'}
              ]
            },
            hard: {
              mc: [
                mc('Python 列表推导式的基本形式是？', '[f(x) for x in xs]', ['list(map(f,xs))','{x for x in xs}','(f(x) for x in xs)'])
              ],
              tf: [
                {q:'dict 的键必须是可哈希的', a:true},
                {q:'生成器是一次性迭代对象', a:true},
                {q:'with 语句用于上下文管理', a:true}
              ],
              code: [ {q:'打印前 n 个斐波那契数', hint:'维护前两个数迭代输出'} ]
            },
            hell: {
              mc: [ mc('Python 元类可用于定制类创建流程吗？', '是', ['否','仅用于类型检查','仅用于继承']) ],
              tf: [ {q:'描述符可拦截属性访问', a:true},{q:'GIL 允许多核并行纯 Python 计算', a:false} ],
              code: [ {q:'实现一个带缓存的斐波那契（memoization）', hint:'使用 dict 记忆化递归或 functools.lru_cache'} ]
            }
          },
          c: {
            easy: {
              mc: [
                mc('C 输出一行文本的函数是？', 'printf()', ['print()', 'System.out.println()', 'fmt.Println()']),
                mc('C 单行注释使用哪个符号？', '//', ['#','<!-- -->','--']),
                mc('C 导入标准库的语句是？', '#include <stdio.h>', ['import java.util.*','using namespace std;','import "fmt"']),
                mc('C 变量声明正确的是？', 'int x = 1;', ['x = 1','auto x = 1;','var x int = 1']),
                mc('C 程序入口是？', 'int main()', ['public static void main','func main()','if __name__ == "__main__":'])
              ],
              tf: [
                {q:'C 数组下标从 0 开始', a:true},
                {q:'C 有类与继承', a:false},
                {q:'指针可存储地址', a:true}
              ],
              code: [ {q:'读取 n，输出 1..n 的和', hint:'使用循环累计或公式'} ]
            },
            hard: {
              mc: [ mc('malloc 返回的指针类型是？', 'void*', ['int*','char*','size_t*']) ],
              tf: [ {q:'free 必须对应 malloc/new 分配的内存', a:true},{q:'栈内存自动回收', a:true} ],
              code: [ {q:'实现字符串反转函数', hint:'指针或数组原地交换'} ]
            },
            hell: {
              mc: [ mc('指针算术 p+1 的步长由什么决定？', '指向类型的大小', ['编译器选项','操作系统页大小','固定为1']) ],
              tf: [ {q:'未定义行为在不同编译器可能表现不同', a:true} ],
              code: [ {q:'实现简易动态数组（push/back 等）', hint:'malloc/realloc 管理容量与大小'} ]
            }
          },
          cpp: {
            easy: {
              mc: [
                mc('C++ 输出一行文本的常用方式是？', 'std::cout << "...";', ['printf("...")','print("...")','fmt.Println("...")']),
                mc('C++ 头文件包含语句是？', '#include <iostream>', ['import java.util.*','using namespace std;','import "fmt"']),
                mc('C++ 程序入口是？', 'int main()', ['public static void main','func main()','if __name__ == "__main__":'])
              ],
              tf: [ {q:'std::vector 位于 std 命名空间', a:true},{q:'C++ 必须手写内存释放', a:false} ],
              code: [ {q:'打印前 n 个斐波那契数', hint:'使用循环推导或 std::vector 存储'} ]
            },
            hard: {
              mc: [ mc('RAII 的核心是？', '对象生命周期管理资源', ['运行时反射','垃圾回收','宏替换']) ],
              tf: [ {q:'引用 & 与指针 * 是不同概念', a:true} ],
              code: [ {q:'实现一个简单的智能指针（引用计数）', hint:'共享计数与析构释放'} ]
            },
            hell: {
              mc: [ mc('模板与泛型编程主要发生在？', '编译期', ['运行期','链接期','加载期']) ],
              tf: [ {q:'完美转发依赖 std::forward', a:true} ],
              code: [ {q:'实现一个模板栈类', hint:'支持 push/pop/top'} ]
            }
          },
          go: {
            easy: {
              mc: [
                mc('Go 输出一行文本的函数是？', 'fmt.Println()', ['print()', 'printf()', 'System.out.println()']),
                mc('Go 导入包的语法是？', 'import "fmt"', ['#include <stdio.h>','import java.util.*','using namespace std;']),
                mc('Go 程序入口是？', 'func main()', ['int main()','public static void main','if __name__ == "__main__":'])
              ],
              tf: [ {q:'Go 使用 := 进行短变量声明', a:true},{q:'Go 需要手动内存释放', a:false} ],
              code: [ {q:'打印 1..n 的和', hint:'使用 for 与累加'} ]
            },
            hard: {
              mc: [ mc('goroutine 的调度由谁负责？', 'Go 运行时', ['操作系统内核','编译器','用户代码']) ],
              tf: [ {q:'channel 可用于 goroutine 间通信', a:true} ],
              code: [ {q:'使用 goroutine 并发计算斐波那契', hint:'用 channel 聚合结果'} ]
            },
            hell: {
              mc: [ mc('select 用于什么场景？', '多通道并发等待', ['字符串选择','泛型约束','反射选择']) ],
              tf: [ {q:'零值初始化是 Go 的语言特性', a:true} ],
              code: [ {q:'实现带缓冲的有界工作池', hint:'channel + goroutine 控制并发数'} ]
            }
          },
          java: {
            easy: {
              mc: [
                mc('Java 输出一行文本的方式是？', 'System.out.println()', ['print()', 'printf()', 'fmt.Println()']),
                mc('Java 导入包的语法是？', 'import java.util.*;', ['#include <stdio.h>','using namespace std;','import "fmt"']),
                mc('Java 程序入口是？', 'public static void main(String[] args)', ['int main()','func main()','if __name__ == "__main__":'])
              ],
              tf: [ {q:'Java 使用垃圾回收', a:true},{q:'Java 不支持泛型', a:false} ],
              code: [ {q:'打印 1..n 的和', hint:'使用 for 与累加'} ]
            },
            hard: {
              mc: [ mc('Java 泛型在什么阶段擦除？', '编译期', ['运行期','链接期','加载期']) ],
              tf: [ {q:'接口可以被类实现', a:true} ],
              code: [ {q:'实现一个线程安全的队列', hint:'使用同步或并发工具类'} ]
            },
            hell: {
              mc: [ mc('反射获取类信息的入口是？', 'Class<?>', ['Method','Field','Package']) ],
              tf: [ {q:'volatile 保证原子性', a:false} ],
              code: [ {q:'实现阻塞队列（生产者-消费者）', hint:'wait/notify 或并发包'} ]
            }
          }
        };

        const quizArea = document.getElementById('quizArea');
        const genBtn = document.getElementById('genQuizBtn');
        const submitBtn = document.getElementById('submitQuizBtn');
        const collapseBtn = document.getElementById('collapseQuizBtn');
        const scoreText = document.getElementById('quizScoreText');
        const langSel = document.getElementById('quizLangSel');
        const levelSel = document.getElementById('quizLevelSel');
        const countSel = document.getElementById('quizCountSel');
        let currentQuizId = '';
        let pyodide = null;

        function pick(arr, n){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a.slice(0, Math.min(n,a.length)); }
        function renderQuiz(lang, level){
          const cfg = QUIZ_CFG[level]; const bank = BANK[lang][level];
          const total = parseInt(countSel.value || '10', 10);
          const mCount = total === 10 ? 5 : 10;
          const tCount = total === 10 ? 5 : 10;
          const mcs = pick(bank.mc, mCount); const tfs = pick(bank.tf, tCount); const code = bank.code[Math.floor(Math.random()*bank.code.length)];
          currentQuizId = 'quiz.'+lang+'.'+level+'.'+Date.now();
          let html = '';
          html += `<h5>选择题（${mCount} 题）</h5>`;
          mcs.forEach((q, i) => {
            html += `<div class="card"><p>${i+1}. ${q.q}</p>`;
            q.options.forEach((opt, k) => {
              html += `<label style="display:block;margin:4px 0;"><input type="radio" name="mc_${i}" value="${k}" /> ${opt}</label>`;
            });
            html += `</div>`;
          });
          html += `<h5>判断题（${tCount} 题）</h5>`;
          tfs.forEach((q, i) => {
            html += `<div class="card"><p>${i+1}. ${q.q}</p>`;
            html += `<label style="margin-right:12px;"><input type="radio" name="tf_${i}" value="true" /> 正确</label>`;
            html += `<label><input type="radio" name="tf_${i}" value="false" /> 错误</label>`;
            html += `</div>`;
          });
          html += '<h5>编程题（1 题）</h5>';
          const runHelp = (lang==='python'||lang==='js'||lang==='java'||lang==='c') ? '（本题支持在线运行，要求编写 solve(n) 并返回结果）' : '（当前语言暂不支持网页内运行，可自行本地验证后勾选“我已完成”）';
          html += `<div class="card"><p>${code.q} ${runHelp}</p><p style="color:var(--muted);">提示：${code.hint || ''}</p>`;
          html += `<textarea id="codeAnswer" rows="8" placeholder="请实现函数 solve(n) 并返回结果；Python 示例：\n\n def solve(n):\n     return n*(n+1)//2\n\nJavaScript 示例：\n\n function solve(n){\n     return n*(n+1)/2\n }\n" style="width:100%;font-family:var(--mono, monospace);"></textarea>`;
          html += `<div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">`;
          html += `<button class="btn" id="runCodeBtn" ${ (lang==='python'||lang==='js'||lang==='java'||lang==='c')?'' : 'disabled' }>运行代码</button>`;
          html += `<span id="runStatus" style="color:var(--muted)"></span>`;
          html += `</div>`;
          html += `<pre id="codeOutput" style="background:#f6f8fa;padding:8px;border-radius:6px;max-height:180px;overflow:auto;margin-top:6px;white-space:pre-wrap;"></pre>`;
          html += `<div style="margin-top:8px;"><label><input type="checkbox" id="codeDoneChk" /> 我已完成并自测通过</label></div>`;
          html += `</div>`;
          quizArea.innerHTML = html;
          submitBtn.disabled = false; collapseBtn.disabled = false; scoreText.textContent = '';

          // 保存答案键以便评分
          quizArea.dataset.lang = lang; quizArea.dataset.level = level;
          quizArea.dataset.mcAnswers = JSON.stringify(mcs.map(q => q.answerIndex));
          quizArea.dataset.tfAnswers = JSON.stringify(tfs.map(q => q.a));
          quizArea.dataset.codeType = inferCodeType(code?.q || '') || '';

          // 绑定运行按钮
          const runBtn = document.getElementById('runCodeBtn');
          const codeOutput = document.getElementById('codeOutput');
          const runStatus = document.getElementById('runStatus');
          const codeTextarea = document.getElementById('codeAnswer');
          if (codeTextarea) codeTextarea.addEventListener('input', () => { try { const uKey = window.Niao?.auth?.getSessionUser?.()||''; saveQuizState(uKey); } catch(_){} });
          if (runBtn) runBtn.addEventListener('click', async () => {
            const langSelNow = quizArea.dataset.lang;
            const taskType = quizArea.dataset.codeType;
            const codeText = codeTextarea.value || '';
            const n = Math.floor(5 + Math.random()*15); // 5..19
            const expected = (taskType==='sum') ? (n*(n+1)/2) : (taskType==='fibo' ? fiboNth(n) : null);
            runStatus.textContent = '正在运行...'; codeOutput.textContent = '';
            try {
              try { const uSave = window.Niao?.auth?.getSessionUser?.()||''; saveQuizState(uSave); } catch(_){}
              let result = null;
              if (langSelNow === 'js') {
                const wrapper = new Function(codeText + `\n;return (typeof solve==='function')?solve(${n}):'__NO_SOLVE__';`);
                result = wrapper();
              } else if (langSelNow === 'python') {
                await ensurePyodide();
                await pyodide.runPythonAsync(codeText);
                result = await pyodide.runPythonAsync(`solve(${n})`);
              } else if (langSelNow === 'java') {
                await ensureCheerpJ();
                result = await runJavaSolve(codeText, n);
              } else if (langSelNow === 'c') {
                await ensureTccWasm();
                result = await runCSolve(codeText, n);
              } else {
                runStatus.textContent = '此语言暂不支持在线运行'; return;
              }
              codeOutput.textContent = `输入 n=${n}\n返回值: ${Array.isArray(result)?JSON.stringify(result):String(result)}`;
              if (expected == null) {
                runStatus.textContent = '已运行（本题不提供在线校验）';
              } else {
                const ok = nearlyEqual(result, expected);
                runStatus.textContent = ok? '通过 ✅（已自动勾选完成）' : `未通过 ❌（期望 ${expected}）`;
                if (ok) { const chk = document.getElementById('codeDoneChk'); if (chk){ chk.checked = true; } }
              }
            } catch (e) {
              runStatus.textContent = '运行失败：' + (e?.message || String(e));
              codeOutput.textContent = '';
            }
          });
        }

        function scoreQuiz(){
          const lang = quizArea.dataset.lang; const level = quizArea.dataset.level; const cfg = QUIZ_CFG[level];
          const mcAns = JSON.parse(quizArea.dataset.mcAnswers||'[]');
          const tfAns = JSON.parse(quizArea.dataset.tfAnswers||'[]');
          let mcScore = 0; let tfScore = 0; let codeScore = 0;
          mcAns.forEach((ans, i) => {
            const chosen = document.querySelector(`input[name="mc_${i}"]:checked`);
            if (chosen && parseInt(chosen.value,10) === ans) mcScore += cfg.choice;
          });
          tfAns.forEach((ans, i) => {
            const chosen = document.querySelector(`input[name="tf_${i}"]:checked`);
            if (chosen && String(chosen.value) === String(ans)) tfScore += cfg.tf;
          });
          const codeDone = document.getElementById('codeDoneChk')?.checked;
          if (codeDone) codeScore = cfg.code;
          return { mcScore, tfScore, codeScore, total: mcScore + tfScore + codeScore };
        }

        function preventDoubleAward(){
          if (!u) return true;
          const key = 'niao.quiz.awarded.'+u+'.'+currentQuizId;
          const done = readRaw(key, '')==='1';
          if (!done) writeRaw(key, '1');
          return done; // true 表示已计过分
        }

        if (genBtn) genBtn.addEventListener('click', () => {
          if (!u) { alert('请先登录再参与答题与计分'); return; }
          const lang = langSel.value; const level = levelSel.value;
          try { renderQuiz(lang, level); try { saveQuizState(u); } catch(_){} } catch(e){ quizArea.innerHTML = '<p>生成试卷失败</p>'; }
        });

        if (submitBtn) submitBtn.addEventListener('click', async () => {
          if (!u) { alert('请先登录'); return; }
          if (!currentQuizId) { alert('请先生成试卷'); return; }
          const s = scoreQuiz();
          try { saveQuizHistory(u, { lang: quizArea.dataset.lang, level: quizArea.dataset.level, mcScore: s.mcScore, tfScore: s.tfScore, codeScore: s.codeScore, total: s.total }); } catch(_){}
          if (preventDoubleAward()) { alert('本次试卷已结算过积分'); return; }
          await window.Niao?.auth?.addPoints(u, s.total, 'quiz:'+currentQuizId);
          const pts = await window.Niao?.auth?.getPoints(u); taskPoints.textContent = String(pts||0);
          scoreText.textContent = `选择得分 ${s.mcScore}，判断得分 ${s.tfScore}，编程额外 ${s.codeScore}，总计 +${s.total} 积分`;
          alert(`计分完成：本次获得 +${s.total} 积分`);
          // 提交后允许收起试卷
          if (collapseBtn) { collapseBtn.disabled = false; }
        });

        if (collapseBtn) collapseBtn.addEventListener('click', () => {
          quizArea.innerHTML = '<p style="color:var(--muted)">试卷已收起。如需重新生成，请点击“生成试卷”。</p>';
          submitBtn.disabled = true; collapseBtn.disabled = true; scoreText.textContent = '';
        });

        // ====== 代码运行支持与工具函数 ======
        function inferCodeType(text){
          const t = String(text||'');
          if (/斐波那契|fibo/i.test(t)) return 'fibo';
          if (/1\..*n.*和|求和|sum\(range/i.test(t)) return 'sum';
          return '';
        }
        async function ensurePyodide(){
          if (pyodide) return pyodide;
          if (!window.loadPyodide) {
            const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
            document.head.appendChild(s);
            await new Promise((resolve, reject) => { s.onload = resolve; s.onerror = () => reject(new Error('Pyodide 加载失败')); });
          }
          pyodide = await window.loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/' });
          return pyodide;
        }
        // ====== Java (CheerpJ + JDK) 运行支持 ======
        let cjReady = false;
        async function ensureCheerpJ(){
          if (cjReady && window.cheerpjRunMain) return true;
          if (!window.cheerpjInit) {
            const candidates = [
              'https://cjrtnc.leaningtech.com/3.0/cheerpj.js',
              'https://cjrtnc.leaningtech.com/2.3/cheerpj.js'
            ];
            let loaded = false;
            for (const url of candidates){
              try {
                await new Promise((resolve, reject) => {
                  const s = document.createElement('script'); s.src = url; s.async = true;
                  s.onload = resolve; s.onerror = () => reject(new Error('CheerpJ 加载失败: '+url));
                  document.head.appendChild(s);
                });
                loaded = true; break;
              } catch (e){ /* try next */ }
            }
            if (!loaded) throw new Error('CheerpJ 运行时加载失败，请检查网络或更换 CDN。');
          }
          try { if (window.cheerpjInit) window.cheerpjInit(); } catch(_){}
          cjReady = !!window.cheerpjRunMain;
          return cjReady;
        }
        async function runJavaSolve(srcText, n){
          // 要求：用户提供类 Solution，包含 static int solve(int n)
          const userSrc = String(srcText||'');
          const hasClass = /class\s+Solution\b/.test(userSrc);
          const wrapped = hasClass ? userSrc : (
            'public class Solution {\n' +
            '  public static int solve(int n){\n' +
            '    // TODO: 请实现\n' +
            '    return n;\n' +
            '  }\n' +
            '}'
          );
          const runner = (
            'import java.io.*;\n' +
            'public class Runner {\n' +
            '  public static void main(String[] args) throws Exception {\n' +
            '    int n = Integer.parseInt(args[0]);\n' +
            '    int r = Solution.solve(n);\n' +
            '    try(PrintWriter pw = new PrintWriter(new FileWriter("/str/out.txt"))){ pw.println(r); }\n' +
            '    System.out.println(r);\n' +
            '  }\n' +
            '}'
          );
          if (!window.cheerpOSAddStringFile) throw new Error('CheerpJ 文件系统 API 不可用');
          // 写入到 /str（内存文件系统）
          window.cheerpOSAddStringFile('/str/Solution.java', wrapped);
          window.cheerpOSAddStringFile('/str/Runner.java', runner);
          // 编译与运行（显式设置类路径到 /str）
          try {
            await window.cheerpjRunMain('javac', ['-cp','/str','/str/Solution.java','/str/Runner.java']);
          } catch(e){ throw new Error('javac 编译失败：' + (e?.message||String(e))); }
          try {
            await window.cheerpjRunMain('java', ['-cp','/str','Runner', String(n)]);
          } catch(e){ throw new Error('java 运行失败：' + (e?.message||String(e))); }
          // 读取输出文件
          if (window.cjFileBlob) {
            try {
              const blob = await window.cjFileBlob('/str/out.txt');
              const text = await blob.text();
              return Number(text.trim());
            } catch(_){}
          }
          return undefined;
        }
        // ====== C (TCC-WASM) 运行支持（占位与懒加载） ======
        let tccReady = false; let TCC = null;
        async function ensureTccWasm(){
          if (tccReady && TCC) return true;
          const candidates = [
            // 如需离线使用，可将 tcc.js/tcc.wasm 放到 assets/ 并改相对路径
            'https://unpkg.com/@rspeed/tcc-wasm/dist/tcc.js',
            'https://unpkg.com/tcc-wasm/dist/tcc.min.js'
          ];
          let loaded = false;
          for (const url of candidates){
            try {
              await new Promise((resolve, reject) => {
                const s = document.createElement('script'); s.src = url; s.async = true;
                s.onload = resolve; s.onerror = () => reject(new Error('TCC-WASM 加载失败: '+url));
                document.head.appendChild(s);
              });
              loaded = true; break;
            } catch (e){ /* try next */ }
          }
          if (!loaded) throw new Error('TCC-WASM 运行时加载失败，请检查网络或更换 CDN。');
          TCC = window.TCC || window.Module || null; tccReady = !!TCC; return tccReady;
        }
        async function runCSolve(srcText, n){
          const code = String(srcText||'');
          const hasSign = /int\s+solve\s*\(\s*int\s+n\s*\)/.test(code);
          if (!hasSign) throw new Error('请实现函数签名：int solve(int n)');
          // 占位：不同 TCC-WASM 包的 API 差异较大，这里暂不编译运行，后续接入指定版本后完善
          throw new Error('TCC-WASM 暂未初始化完成，请稍后或配置本地资产后重试');
        }
        function fiboNth(n){ if (n<=2) return 1; let a=1,b=1; for(let i=3;i<=n;i++){ const c=a+b; a=b; b=c; } return b; }
        function nearlyEqual(a,b){ const na=Number(a), nb=Number(b); if(!isNaN(na)&&!isNaN(nb)) return Math.abs(na-nb) < 1e-9; return String(a)===String(b); }
        // ====== 持久化（localStorage） ======
        function saveQuizState(user){
          try {
            const uKey = String(user||''); if (!uKey) return;
            const key = 'niao.quiz.state.'+uKey;
            const state = {
              ts: Date.now(),
              quizId: currentQuizId || '',
              lang: quizArea?.dataset?.lang || '',
              level: quizArea?.dataset?.level || '',
              code: document.getElementById('codeAnswer')?.value || '',
              codeType: quizArea?.dataset?.codeType || ''
            };
            writeRaw(key, JSON.stringify(state));
          } catch(_){}
        }
        function saveQuizHistory(user, summary){
          try {
            const uKey = String(user||''); if (!uKey) return;
            const key = 'niao.quiz.history.'+uKey;
            const hist = JSON.parse(readRaw(key, '[]'));
            hist.push({ ts: Date.now(), quizId: currentQuizId||'', ...summary });
            writeRaw(key, JSON.stringify(hist));
          } catch(_){}
        }
      })();
    </script>
  </body>
  </html>